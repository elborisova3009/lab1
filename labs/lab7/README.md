### Лабораторная работа 7. Развертывание коммутируемой сети с резервными каналами

#### Топология 
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20114403.jpg)

#### Таблица адресации
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20114706-1.jpg)

#### Цели
Часть 1. Создание сети и настройка основных параметров устройства  
Часть 2. Выбор корневого моста  
Часть 3. Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов  
Часть 4. Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов  

#### Часть 1:	Создание сети и настройка основных параметров устройства

Шаг 1:	Создайте сеть согласно топологии.  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20150037.jpg)  

Шаг 2:	Выполнение инициализации и перезагрузки коммутаторов в CPT не требуется.

Шаг 3:	Настрою базовые параметры каждого коммутатора. Для примера S1:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20125135.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20125932.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20125951.jpg)

S1 show run:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20130211.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20130227.jpg)

Аналогично для S2 и S3.  
S2 show run:   
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20131627.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20131639.jpg)  
S3 show run:      
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20141520.jpg)   
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20141532.jpg)

Шаг 4:	Проверю связь.  
Нет пингов.

Дополню конфигурационные файлы настройкой куммутационных портов, определю все интерфейсы во VLAN 88.

Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S2? *Да.*  

Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S3? *Да.*  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20144526.jpg)  


Успешно ли выполняется эхо-запрос от коммутатора S2 на коммутатор S3?	*Да.*    
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20145150.jpg)  

#### Часть 2:	Определение корневого моста  
Для каждого экземпляра протокола spanning-tree (коммутируемая сеть LAN или широковещательный домен) существует коммутатор, выделенный в качестве корневого моста. Корневой мост служит точкой привязки для всех расчётов протокола spanning-tree, позволяя определить избыточные пути, которые следует заблокировать.  
Процесс выбора определяет, какой из коммутаторов станет корневым мостом. Коммутатор с наименьшим значением идентификатора моста (BID) становится корневым мостом. Идентификатор BID состоит из значения приоритета моста, расширенного идентификатора системы и MAC-адреса коммутатора. Значение приоритета может находиться в диапазоне от 0 до 65535 с шагом 4096. По умолчанию используется значение 32768.  

Шаг 1:	Отключите все порты на коммутаторах.  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20150145-1.jpg)  

Аналогично для S1 и S3. 

![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2021-10-2022%20150348.jpg)

Шаг 2:	Настройте подключенные порты в качестве транковых.  

Шаг 3:	Включите порты F0/2 и F0/4 на всех коммутаторах.

![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130109.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130134.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130239.jpg)  

Шаг 4:	Отобразите данные протокола spanning-tree.

S1:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130647.jpg)  
S2:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130717.jpg)  
S3:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20130736.jpg)

Приоритет идентификатора моста рассчитывается путем сложения значений приоритета и расширенного идентификатора системы.  
Расширенным идентификатором системы всегда является номер сети VLAN. В примере ниже все три коммутатора имеют равные значения приоритета идентификатора моста (32856 = 32768 + 88, где приоритет по умолчанию = 32768, номер сети VLAN = 88).  
Следовательно, коммутатор с самым низким значением MAC-адреса становится корневым мостом.  
В данной работе — это S2:  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20131150.jpg)

Заполню схему, запишу роли (Role) и состояния (Sts) портов на каждом коммутаторе в топологии.  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2024-10-2022%20163928-2.jpg)

С учетом выходных данных, поступающих с коммутаторов, ответьте на следующие вопросы.
Какой коммутатор является корневым мостом? *S2*   

Почему этот коммутатор был выбран протоколом spanning-tree в качестве корневого моста?  
*Все три коммутатора имеют равные значения приоритета идентификатора моста = 32856, но у S2 самое низкое значение MAC-адреса = 000A.419D.EB67.  
Поэтому, он становится корневым мостом.*

Какие порты на коммутаторе являются корневыми портами?  
*Порты коммутатора, которые имеют кратчайший путь к корневому коммутатору.*

Какие порты на коммутаторе являются назначенными портами?  
*Назначенный (designated или Desg в синтаксисе) порт — некорневой порт моста между сегментами сети, принимающий трафик из соответствующего сегмента. У корневого коммутатора все порты — назначенные.

Какой порт отображается в качестве альтернативного и в настоящее время заблокирован?  
*S1 F0/4: Altn BLK*  

Почему протокол spanning-tree выбрал этот порт в качестве невыделенного (заблокированного) порта?    
*После определения всех корневых и назначенных портов на всех мостах блокируются оставшиеся порты. Они считаются невыделенными.    

#### Часть 3:	Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов

Алгоритм протокола spanning-tree (STA) использует корневой мост как точку привязки, после чего определяет, какие порты будут заблокированы, исходя из стоимости пути. Порт с более низкой стоимостью пути является предпочтительным. Если стоимости портов равны, процесс сравнивает BID. Если BID равны, для определения корневого моста используются приоритеты портов. Наиболее низкие значения являются предпочтительными. В части я буду изменять стоимость порта, чтобы определить, какой порт будет заблокирован протоколом spanning-tree.

Шаг 1:	Определю коммутатор с заблокированным портом.
При текущей конфигурации только один коммутатор содерджит заблокированный протоколом STP порт.  
Выполню команду show spanning-tree на обоих коммутаторах некорневого моста.  
SPT блокирует порт F0/4 на коммутаторе S1, у которого самый высокий идентификатор BID.  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20131913.jpg)  

Шаг 2:	Изменю стоимость порта.
Помимо заблокированного порта, единственным активным портом на этом коммутаторе является порт, выделенный в качестве порта корневого моста. 
Уменьшу согласно заданию стоимость этого порта корневого моста до 18, выполнив команду spanning-tree cost 18 режима конфигурации интерфейса.

S1(config)# interface f0/2
S1(config-if)# spanning-tree cost 18

Как выяснилось после длительных попыток починить то, что не было поломано, а является особенностью CPT - симулятор не позволяет менять стоимость порта. 

Шаг 3:	Не смогу посмотреть изменения протокола spanning-tree. Фальсифицирую их, скорректировав из задания. 
Сделаю вид, что повторно выполнила команду show spanning-tree на обоих коммутаторах некорневого моста. Ранее заблокированный порт (S1 – Fа 0/4) теперь является назначенным портом, и протокол spanning-tree теперь блокирует порт на другом коммутаторе некорневого моста (S3 – Fа 0/4). 

![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20142118.jpg)  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20142129.jpg)  

Почему протокол spanning-tree заменяет ранее заблокированный порт на назначенный порт и блокирует порт, который был назначенным портом на другом коммутаторе?  
*На основании расчёта стоимости пути.  
STP использует Spanning Tree Algorithm (STA), для определния порта для блокировки.  
Для этого STA использует корневой коммутатор, как точку отсчета для расчета всех путей. После выбора root bridge, STA рассчитывает кратчайший путь к нему.  
Каждый коммутатор использует STA, чтобы определить, какой порт блокировать. Пока STA выбирает кратчайшие пути, коммутатор не имеет возможности передавать данные по сети. Для определения кратчайшего пути STA использует стоимость пути.  
Стоимость пути рассчитывается исходя из скоростей всех портов на протяжении пути. Сумма стоимостей участков в пути составляет стоимость пути. Если есть больше чем один путь, STA выбирает путь с меньшей стоимостью.  
Когда STA определил, какие пути оставить доступными, он переназначает роли портам коммутаторов.*

Шаг 4:	"Удалю" не примененные изменения стоимости порта.    
a.	Выполню команду no spanning-tree cost 18 в режиме конфигурации интерфейса, чтобы удалить запись стоимости, созданную ранее.  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20142729.jpg)  

b.	Повторно выполню команду show spanning-tree, чтобы подтвердить, что протокол STP сбросил порт на коммутаторе некорневого моста, вернув исходные настройки порта. Протоколу STP требуется примерно 30 секунд, чтобы завершить процесс перевода порта.

#### Часть 4:	Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов

Если стоимости портов равны, процесс сравнивает BID. Если BID равны, для определения корневого моста используются приоритеты портов. Значение приоритета по умолчанию — 128. STP объединяет приоритет порта с номером порта, чтобы разорвать связи. Наиболее низкие значения являются предпочтительными. В части 4 предстоит активировать избыточные пути до каждого из коммутаторов, чтобы просмотреть, каким образом протокол STP выбирает порт с учетом приоритета портов.

a.	Включу порты Fa 0/1 и Fa 0/3 на всех коммутаторах.  

Для примера S1 (S2 и S3 аналогично):  
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20143408.jpg)

b.	Подожду, чтобы протокол STP завершил процесс перевода порта, после чего выполню команду show spanning-tree на коммутаторах некорневого моста. 
Порт корневого моста переместился на порт с меньшим номером, связанный с коммутатором корневого моста, и заблокировал предыдущий порт корневого моста.   
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20144056.jpg)   
![alt text](https://github.com/elborisova3009/otus-networks/blob/master/labs/lab7/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%2025-10-2022%20144206.jpg)  


Какой порт выбран протоколом STP в качестве порта корневого моста на каждом коммутаторе некорневого моста? *Для обоих коммутаторов это порт Fa 0/1.*
Почему протокол STP выбрал эти порты в качестве портов корневого моста на этих коммутаторах? *На основании данных колонки Prio.Nbr, где Priority Number - это приоритет порта. По-умолчанию этот параметр равен 128, а после точки записывается порядковый номер порта. Соответственно для Fa0/1 — это 128.1, а для Fa0/2 — 128.2. Выбраны порты с меньшими Prio.Nbr.*  

#### Вопросы для повторения

1.	Какое значение протокол STP использует первым после выбора корневого моста, чтобы определить выбор порта?  
*Порт с более низкой стоимостью пути до корневого.* 
2.	Если первое значение на двух портах одинаково, какое следующее значение будет использовать протокол STP при выборе порта?  
*Если стоимости портов равны, процесс сравнивает BID.*  
3.	Если оба значения на двух портах равны, каким будет следующее значение, которое использует протокол STP при выборе порта?
*Если BID равны, для определения корневого моста используются приоритеты портов. Наиболее низкие значения являются предпочтительными.*
